name: Kondukto security scan

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  TARGET_BRANCH: main

jobs:
  run-scans:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        tool:
          - dependabot
          - semgrep
          - osvscannersca
          - gitleaks
          - trufflehogsecurity
          - snyksast

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Install KDT CLI
      run: |
        curl -sSL https://cli.kondukto.io | sh

    - name: Scan with ${{ matrix.tool }}
      run: |
        kdt scan \
        --host ${{ secrets.KONDUKTO_HOST }} \
        --token ${{ secrets.KONDUKTO_TOKEN }} \
        -p ${{ secrets.PROJECT_NAME }} \
        -t ${{ matrix.tool }} \
        -b $TARGET_BRANCH \
        --async
